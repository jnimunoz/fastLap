<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="fragments/base :: base('Panel de carrera', ~{::section})">
<section class="grid two">
    <div class="card">
        <h2 th:text="${activeRace != null} ? 'Carrera en progreso' : 'Iniciar nueva carrera'"></h2>
        <div th:if="${activeRace != null}" class="grid">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Nombre</h3>
                    <p th:text="${activeRace.name()}"></p>
                </div>
                <div class="stat-card">
                    <h3>Inicio</h3>
                    <p th:text="${#temporals.format(activeRace.startTime(), 'dd MMM yyyy HH:mm')}"></p>
                </div>
                <div class="stat-card">
                    <h3>Vueltas totales</h3>
                    <p th:text="${activeRace.totalLaps()}"></p>
                </div>
            </div>
            <form th:action="@{'/race/' + ${activeRace.id()} + '/finish'}" method="post">
                <button type="submit" class="button destructive">Finalizar carrera</button>
            </form>
        </div>
        <div th:if="${activeRace == null}">
            <p class="muted">No hay una carrera activa. Registra una para comenzar a contabilizar vueltas.</p>
            <form th:action="@{/race/start}" th:object="${raceForm}" method="post" class="grid">
                <div class="form-group">
                    <label for="name">Nombre de la carrera</label>
                    <input id="name" type="text" th:field="*{name}" placeholder="Entrenamiento nocturno">
                    <div class="field-error" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                </div>
                <div class="form-group">
                    <label for="description">Descripción</label>
                    <textarea id="description" th:field="*{description}" rows="3" placeholder="Notas u objetivos del entrenamiento"></textarea>
                    <div class="field-error" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                </div>
                <div>
                    <button type="submit" class="button">Iniciar carrera</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <h2>Corredores</h2>
        <p class="muted" th:if="${activeRace == null}">Inicia una carrera para habilitar el registro de vueltas.</p>
        <p class="muted" th:if="${#lists.isEmpty(runners)}">Registra corredores antes de comenzar una carrera.</p>
        <div class="runner-grid" th:if="${!#lists.isEmpty(runners)}">
            <div class="runner-card" th:each="runner : ${runners}">
                <div>
                    <div class="name">
                        <span th:text="${runner.firstName()}"></span>
                        <span th:text="${runner.lastName()}"></span>
                    </div>
                    <div class="nickname">Apodo: <span th:text="${runner.nickname()}"></span></div>
                </div>
                <div class="muted">Vueltas: <span th:text="${lapCounts[runner.id()] != null ? lapCounts[runner.id()] : 0}"></span></div>
                <form th:if="${activeRace != null}" th:action="@{'/race/' + ${activeRace.id()} + '/lap'}" method="post">
                    <input type="hidden" name="runnerId" th:value="${runner.id()}">
                    <button type="submit" class="button small">Registrar vuelta</button>
                </form>
            </div>
        </div>
    </div>
</section>
<section class="card" th:if="${activeRace != null}">
    <h2>Vuelta a vuelta</h2>
    <table>
        <thead>
        <tr>
            <th>#</th>
            <th>Corredor</th>
            <th>Tiempo</th>
            <th>Registrado</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="lap, iter : ${laps}">
            <td th:text="${lap.lapNumber()}"></td>
            <td th:text="${lap.runnerNickname()}"></td>
            <td th:text="${lap.formattedLapTime()}"></td>
            <td th:text="${#temporals.format(lap.recordedAt(), 'HH:mm:ss')}"></td>
        </tr>
        <tr th:if="${#lists.isEmpty(laps)}">
            <td colspan="4" class="muted">Aún no se han registrado vueltas.</td>
        </tr>
        </tbody>
    </table>
</section>
</html>
